#!/bin/sh
set -eu

PYTHON_BIN="${PYTHON_BIN:-python}"
if ! command -v "$PYTHON_BIN" >/dev/null 2>&1; then
  PYTHON_BIN="python3"
fi

if ! command -v "$PYTHON_BIN" >/dev/null 2>&1; then
  echo "report-link hook: python is required but was not found" >&2
  exit 1
fi

STAGED_REPORTS="$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^ebay-arbitrage-plugin/reports/.*\.md$' || true)"

if [ -z "$STAGED_REPORTS" ]; then
  exit 0
fi

"$PYTHON_BIN" ebay-arbitrage-plugin/scripts/report_link_guard.py $STAGED_REPORTS --normalize-ebay-links --write --skip-network >/dev/null

echo "$STAGED_REPORTS" | while IFS= read -r report_path; do
  if [ -n "$report_path" ]; then
    git add "$report_path"
  fi
done

echo "report-link hook: normalized report links in staged markdown report(s)"
